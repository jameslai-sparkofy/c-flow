<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å»ºç¯‰å·¥åœ°ç®¡ç†ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', 'Microsoft JhengHei', sans-serif;
            background: #f5f6fa;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 1.8em;
            margin: 0;
        }
        
        .view-tabs {
            display: flex;
            gap: 10px;
        }
        
        .tab-btn {
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            background: white;
            color: #2c3e50;
            font-weight: bold;
        }
        
        .tab-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .tab-btn.active:hover {
            background: white;
        }
        
        .main-container {
            display: grid;
            grid-template-columns: 380px 1fr;
            height: calc(100vh - 70px);
        }
        
        .sidebar {
            background: white;
            border-right: 2px solid #e9ecef;
            overflow-y: auto;
            padding: 20px;
        }
        
        .content-area {
            background: white;
            overflow: auto;
            position: relative;
        }
        
        .control-section {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }
        
        .control-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #34495e;
            font-size: 0.9em;
        }
        
        .input-group input,
        .input-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .checkbox-group {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 0;
            font-weight: normal;
        }
        
        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            width: 100%;
            margin-bottom: 8px;
            transition: all 0.3s;
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }
        
        .task-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            background: white;
        }
        
        .task-item {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
            cursor: move;
            background: white;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 6px;
            margin-bottom: 2px;
            border-left: 4px solid #3498db;
        }
        
        .task-item:hover {
            background: #f8f9fa;
            transform: translateX(3px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .task-item.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
        }
        
        .task-item.water-electric { border-left-color: #00b894; }
        .task-item.masonry { border-left-color: #fd79a8; }
        .task-item.carpentry { border-left-color: #fdcb6e; }
        .task-item.painting { border-left-color: #74b9ff; }
        .task-item.flooring { border-left-color: #a29bfe; }
        
        .task-info {
            flex: 1;
        }
        
        .task-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 3px;
        }
        
        .task-details {
            font-size: 0.8em;
            color: #7f8c8d;
        }
        
        .task-actions {
            display: flex;
            gap: 5px;
        }
        
        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            background: #e74c3c;
            color: white;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }
        
        .stat-item h4 {
            font-size: 1.1em;
            margin-bottom: 2px;
        }
        
        .stat-item p {
            font-size: 0.75em;
            opacity: 0.9;
        }
        
        /* è¦–åœ–æ¨£å¼ */
        .view {
            display: none;
            padding: 20px;
        }
        
        .view.active {
            display: block;
        }
        
        /* ç”˜ç‰¹åœ–æ¨£å¼ - ä¿®æ”¹éƒ¨åˆ† */
        .gantt-container {
            position: relative;
            overflow-x: auto;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
        }
        
        .gantt-chart {
            display: table;
            min-width: 100%;
            position: relative;
        }
        
        .gantt-header {
            display: table-row;
            background: #34495e;
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .gantt-lane-header {
            display: table-cell;
            width: 200px;
            padding: 15px;
            border-right: 1px solid #2c3e50;
            text-align: center;
            vertical-align: middle;
            position: sticky;
            left: 0;
            background: #34495e;
            z-index: 101;
        }
        
        .gantt-timeline-header {
            display: table-cell;
            position: relative;
        }
        
        .gantt-days-container {
            display: flex;
            position: relative;
        }
        
        .gantt-day {
            width: 40px;
            min-width: 40px;
            padding: 10px 5px;
            border-right: 1px solid #2c3e50;
            text-align: center;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .gantt-day:hover {
            opacity: 0.8;
        }
        
        .gantt-day.weekend {
            background: #e74c3c;
            color: white;
        }
        
        .gantt-day.holiday {
            background: #9b59b6;
            color: white;
        }
        
        .gantt-day.today {
            background: #f39c12;
            color: white;
            font-weight: bold;
        }
        
        .gantt-lane {
            display: table-row;
            position: relative;
        }
        
        .gantt-lane-label {
            display: table-cell;
            width: 200px;
            padding: 8px 10px;
            border-right: 1px solid #bdc3c7;
            border-bottom: 1px solid #bdc3c7;
            background: #ecf0f1;
            font-weight: bold;
            font-size: 14px;
            color: #2c3e50;
            vertical-align: middle;
            position: sticky;
            left: 0;
            z-index: 10;
            writing-mode: horizontal-tb;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .gantt-lane-content {
            display: table-cell;
            position: relative;
            height: 60px;
            background: white;
            border-bottom: 1px solid #bdc3c7;
        }
        
        .gantt-grid {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
        }
        
        .gantt-day-column {
            width: 40px;
            min-width: 40px;
            border-right: 1px solid #ecf0f1;
            height: 100%;
        }
        
        .gantt-day-column.weekend {
            background: rgba(231, 76, 60, 0.1);
        }
        
        .gantt-day-column.holiday {
            background: rgba(155, 89, 182, 0.1);
        }
        
        .gantt-day-column.today {
            background: rgba(243, 156, 18, 0.1);
            border-right: 2px solid #f39c12;
        }
        
        .gantt-task {
            position: absolute;
            top: 10px;
            height: 40px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: white;
            cursor: move;
            transition: opacity 0.3s, transform 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 20;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            padding: 0 8px;
            user-select: none;
        }
        
        .gantt-task:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            z-index: 30;
        }
        
        .gantt-task.dragging {
            opacity: 0.7;
            z-index: 1000;
            cursor: grabbing;
        }
        
        .gantt-task.resizing {
            cursor: ew-resize;
        }
        
        /* èª¿æ•´æ‰‹æŸ„ */
        .gantt-task .resize-handle {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 10px;
            cursor: ew-resize;
            z-index: 21;
        }
        
        .gantt-task .resize-handle-left {
            left: 0;
            cursor: w-resize;
        }
        
        .gantt-task .resize-handle-right {
            right: 0;
            cursor: e-resize;
        }
        
        .gantt-task .resize-handle:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* é¡è‰²ä¸»é¡Œ */
        .water-electric { background: linear-gradient(135deg, #00b894, #00a085); }
        .masonry { background: linear-gradient(135deg, #fd79a8, #e84393); }
        .carpentry { background: linear-gradient(135deg, #fdcb6e, #e17055); }
        .painting { background: linear-gradient(135deg, #74b9ff, #0984e3); }
        .flooring { background: linear-gradient(135deg, #a29bfe, #6c5ce7); }
        
        /* å…¶ä»–è¦–åœ–æ¨£å¼ä¿æŒä¸è®Š */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .calendar-nav {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .calendar-nav button {
            padding: 8px 12px;
            border: none;
            background: #3498db;
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .calendar-day {
            background: white;
            min-height: 120px;
            padding: 8px;
            position: relative;
        }
        
        .calendar-day.other-month {
            background: #f8f9fa;
            color: #aaa;
        }
        
        .calendar-day.weekend {
            background: #fff5f5;
        }
        
        .calendar-day-number {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .calendar-task {
            background: #3498db;
            color: white;
            padding: 2px 6px;
            margin: 2px 0;
            border-radius: 3px;
            font-size: 11px;
            cursor: pointer;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .kanban-board {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .kanban-column {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            min-height: 500px;
        }
        
        .kanban-header {
            font-weight: bold;
            margin-bottom: 15px;
            padding: 12px;
            background: #2c3e50;
            color: white;
            border-radius: 6px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 50px;
        }
        
        .kanban-header.water-electric { background: linear-gradient(135deg, #00b894, #00a085); }
        .kanban-header.masonry { background: linear-gradient(135deg, #fd79a8, #e84393); }
        .kanban-header.carpentry { background: linear-gradient(135deg, #fdcb6e, #e17055); }
        .kanban-header.painting { background: linear-gradient(135deg, #74b9ff, #0984e3); }
        .kanban-header.flooring { background: linear-gradient(135deg, #a29bfe, #6c5ce7); }
        
        .kanban-card {
            background: white;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid #ddd;
        }
        
        .kanban-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .kanban-card-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .kanban-card-details {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .kanban-card-financial {
            font-size: 11px;
            color: #555;
            background: rgba(52, 152, 219, 0.1);
            padding: 6px;
            border-radius: 4px;
        }
        
        .kanban-card-status {
            margin-top: 8px;
            text-align: center;
        }
        
        .status-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            color: white;
        }
        
        .status-indicator.planned { background: #f39c12; }
        .status-indicator.inprogress { background: #3498db; }
        .status-indicator.completed { background: #27ae60; }
        .status-indicator.blocked { background: #e74c3c; }
        
        .list-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .list-table th {
            background: #2c3e50;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
        }
        
        .list-table td {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
            position: relative;
        }
        
        .list-table tr:hover {
            background: #f8f9fa;
        }
        
        .editable-cell {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .editable-cell:hover {
            background: #e3f2fd;
        }
        
        .editable-cell.editing {
            padding: 0;
        }
        
        .edit-input {
            width: 100%;
            padding: 4px 8px;
            border: 2px solid #3498db;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }
        
        .edit-select {
            width: 100%;
            padding: 4px 8px;
            border: 2px solid #3498db;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
            background: white;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .status-badge:hover {
            transform: scale(1.05);
        }
        
        .status-planned { background: #f39c12; color: white; }
        .status-inprogress { background: #3498db; color: white; }
        .status-completed { background: #27ae60; color: white; }
        .status-blocked { background: #e74c3c; color: white; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ—ï¸ å»ºç¯‰å·¥åœ°ç®¡ç†ç³»çµ±</h1>
        <div class="view-tabs">
            <button class="tab-btn active" onclick="switchView('gantt', event)">ğŸŠâ€â™‚ï¸ ç”˜ç‰¹åœ–</button>
            <button class="tab-btn" onclick="switchView('calendar', event)">ğŸ“… æ—¥æ›†</button>
            <button class="tab-btn" onclick="switchView('kanban-category', event)">ğŸ—ï¸ å·¥ç¨‹çœ‹æ¿</button>
            <button class="tab-btn" onclick="switchView('kanban-status', event)">ğŸ“‹ é€²åº¦çœ‹æ¿</button>
            <button class="tab-btn" onclick="switchView('list', event)">ğŸ“ åˆ—è¡¨</button>
        </div>
    </div>
    
    <div class="main-container">
        <div class="sidebar">
            <div class="control-section">
                <h3>ğŸ“… å°ˆæ¡ˆè¨­å®š</h3>
                <div class="input-group">
                    <label for="startDate">å°ˆæ¡ˆé–‹å§‹æ—¥æœŸ</label>
                    <input type="date" id="startDate">
                </div>
                <div class="input-group">
                    <label>ä¸æ’å·¥æ—¥è¨­å®š</label>
                    <div class="checkbox-group">
                        <label>
                            <input type="checkbox" id="skipSaturday"> é€±å…­
                        </label>
                        <label>
                            <input type="checkbox" id="skipSunday" checked> é€±æ—¥
                        </label>
                    </div>
                </div>
                <button class="btn btn-success" onclick="updateSchedule()">ğŸ”„ æ›´æ–°æ’ç¨‹</button>
            </div>
            
            <div class="control-section">
                <h3>â• æ–°å¢å·¥åº</h3>
                <div class="input-group">
                    <label for="category">å·¥ç¨‹é¡åˆ¥</label>
                    <select id="category">
                        <option value="water-electric">ğŸ’§ æ°´é›»å·¥ç¨‹</option>
                        <option value="masonry">ğŸ§± æ³¥ä½œå·¥ç¨‹</option>
                        <option value="carpentry">ğŸªµ æœ¨å·¥å·¥ç¨‹</option>
                        <option value="painting">ğŸ¨ æ²¹æ¼†å·¥ç¨‹</option>
                        <option value="flooring">ğŸ  åœ°æ¿å·¥ç¨‹</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="taskName">å·¥åºåç¨±</label>
                    <input type="text" id="taskName" placeholder="è¼¸å…¥å·¥åºåç¨±">
                </div>
                <div class="input-group">
                    <label for="duration">å·¥ä½œå¤©æ•¸</label>
                    <input type="number" id="duration" placeholder="å¤©æ•¸" min="1" value="1">
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <label for="cost">æˆæœ¬ (å…ƒ)</label>
                        <input type="number" id="cost" placeholder="æˆæœ¬" min="0">
                    </div>
                    <div class="input-group">
                        <label for="price">å”®åƒ¹ (å…ƒ)</label>
                        <input type="number" id="price" placeholder="å”®åƒ¹" min="0">
                    </div>
                </div>
                <button class="btn" onclick="addTask()">â• æ–°å¢å·¥åº</button>
                <button class="btn btn-warning" onclick="generateTestData()">ğŸ§ª ç”Ÿæˆæ¸¬è©¦è³‡æ–™</button>
                <button class="btn btn-danger" onclick="clearAll()">ğŸ—‘ï¸ æ¸…ç©ºé‡ç½®</button>
            </div>
            
            <div class="control-section">
                <h3>ğŸ“Š å°ˆæ¡ˆçµ±è¨ˆ</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <h4 id="totalTasks">0</h4>
                        <p>ç¸½å·¥åºæ•¸</p>
                    </div>
                    <div class="stat-item">
                        <h4 id="totalCost">0</h4>
                        <p>ç¸½æˆæœ¬</p>
                    </div>
                    <div class="stat-item">
                        <h4 id="totalPrice">0</h4>
                        <p>ç¸½å”®åƒ¹</p>
                    </div>
                    <div class="stat-item">
                        <h4 id="totalProfit">0</h4>
                        <p>ç¸½åˆ©æ½¤</p>
                    </div>
                    <div class="stat-item">
                        <h4 id="totalDays">0</h4>
                        <p>å°ˆæ¡ˆå¤©æ•¸</p>
                    </div>
                    <div class="stat-item">
                        <h4 id="projectEndDate">-</h4>
                        <p>é è¨ˆå®Œå·¥</p>
                    </div>
                </div>
            </div>
            
            <div class="control-section">
                <h3>ğŸ”„ å·¥åºé †åº (å¯æ‹–æ‹‰)</h3>
                <div class="task-list" id="taskList">
                    <p style="text-align: center; color: #7f8c8d; padding: 20px;">
                        å°šæœªæ–°å¢å·¥åº<br>
                        è«‹å…ˆæ–°å¢å·¥åºé …ç›®
                    </p>
                </div>
            </div>
        </div>
        
        <div class="content-area">
            <!-- ç”˜ç‰¹åœ–è¦–åœ– -->
            <div class="view active" id="ganttView">
                <div class="gantt-container">
                    <div id="ganttChart">
                        <div style="text-align: center; color: #7f8c8d; padding: 50px;">
                            <h3>è«‹è¨­å®šå°ˆæ¡ˆé–‹å§‹æ—¥æœŸä¸¦æ–°å¢å·¥åº</h3>
                            <p>ç³»çµ±å°‡è‡ªå‹•ç”¢ç”Ÿæ³³é“ç”˜ç‰¹åœ–</p>
                            <p style="margin-top: 10px; font-size: 14px;">
                                æç¤ºï¼šç”˜ç‰¹åœ–ä¸­çš„å·¥åºæ¢å¯ä»¥ï¼š<br>
                                â€¢ æ‹–æ‹½ç§»å‹•èª¿æ•´é–‹å§‹æ™‚é–“<br>
                                â€¢ æ‹‰å‹•å·¦å³é‚Šç·£èª¿æ•´å·¥æœŸé•·åº¦
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æ—¥æ›†è¦–åœ– -->
            <div class="view" id="calendarView">
                <div class="calendar-header">
                    <h2 id="calendarTitle">2025å¹´8æœˆ</h2>
                    <div class="calendar-nav">
                        <button onclick="navigateCalendar(-1)">â€¹ ä¸Šæœˆ</button>
                        <button onclick="navigateCalendar(0)">ä»Šå¤©</button>
                        <button onclick="navigateCalendar(1)">ä¸‹æœˆ â€º</button>
                    </div>
                </div>
                <div class="calendar-grid" id="calendarGrid">
                    <!-- æ—¥æ›†æ ¼å­æœƒå‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>
            
            <!-- å·¥ç¨‹åˆ†é¡çœ‹æ¿è¦–åœ– -->
            <div class="view" id="kanban-categoryView">
                <div class="kanban-board" id="categoryKanbanBoard">
                    <!-- å·¥ç¨‹åˆ†é¡çœ‹æ¿æœƒå‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>
            
            <!-- é€²åº¦ç‹€æ…‹çœ‹æ¿è¦–åœ– -->
            <div class="view" id="kanban-statusView">
                <div class="kanban-board">
                    <div class="kanban-column">
                        <div class="kanban-header">ğŸ“‹ è¨ˆåŠƒä¸­</div>
                        <div id="kanbanPlanned"></div>
                    </div>
                    <div class="kanban-column">
                        <div class="kanban-header">ğŸ”„ é€²è¡Œä¸­</div>
                        <div id="kanbanInProgress"></div>
                    </div>
                    <div class="kanban-column">
                        <div class="kanban-header">âœ… å·²å®Œæˆ</div>
                        <div id="kanbanCompleted"></div>
                    </div>
                    <div class="kanban-column">
                        <div class="kanban-header">âš ï¸ é˜»å¡</div>
                        <div id="kanbanBlocked"></div>
                    </div>
                </div>
            </div>
            
            <!-- åˆ—è¡¨è¦–åœ– -->
            <div class="view" id="listView">
                <table class="list-table">
                    <thead>
                        <tr>
                            <th>å·¥åºåç¨±</th>
                            <th>å·¥ç¨‹é¡åˆ¥</th>
                            <th>å¤©æ•¸</th>
                            <th>æˆæœ¬</th>
                            <th>å”®åƒ¹</th>
                            <th>åˆ©æ½¤</th>
                            <th>é–‹å§‹æ—¥æœŸ</th>
                            <th>çµæŸæ—¥æœŸ</th>
                            <th>ç‹€æ…‹</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="listTableBody">
                        <!-- åˆ—è¡¨è³‡æ–™æœƒå‹•æ…‹ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let tasks = [];
        let taskIdCounter = 1;
        let projectStartDate = null;
        let skipSaturday = false;
        let skipSunday = true;
        let currentView = 'gantt';
        let currentCalendarDate = new Date();
        let customHolidays = new Set(); // å„²å­˜è‡ªè¨‚ä¼‘æ¯æ—¥
        
        // å·¥ç¨‹é¡åˆ¥è¨­å®š
        const categoryNames = {
            'water-electric': 'ğŸ’§ æ°´é›»å·¥ç¨‹',
            'masonry': 'ğŸ§± æ³¥ä½œå·¥ç¨‹',
            'carpentry': 'ğŸªµ æœ¨å·¥å·¥ç¨‹',
            'painting': 'ğŸ¨ æ²¹æ¼†å·¥ç¨‹',
            'flooring': 'ğŸ  åœ°æ¿å·¥ç¨‹'
        };
        
        // åˆå§‹åŒ–
        function init() {
            document.getElementById('startDate').value = new Date().toISOString().split('T')[0];
            updateStats();
            renderCurrentView();
        }
        
        // æ–°å¢å·¥åº
        function addTask() {
            const category = document.getElementById('category').value;
            const taskName = document.getElementById('taskName').value.trim();
            const duration = parseInt(document.getElementById('duration').value);
            const cost = parseInt(document.getElementById('cost').value) || 0;
            const price = parseInt(document.getElementById('price').value) || 0;
            
            if (!taskName || !duration) {
                alert('è«‹å¡«å¯«å·¥åºåç¨±å’Œå·¥ä½œå¤©æ•¸');
                return;
            }
            
            const task = {
                id: taskIdCounter++,
                category: category,
                name: taskName,
                duration: duration,
                cost: cost,
                price: price,
                profit: price - cost,
                order: tasks.length,
                startDate: null,
                endDate: null,
                status: 'planned',
                manuallyAdjusted: false
            };
            
            tasks.push(task);
            renderTaskList();
            updateSchedule();
            clearInputs();
        }
        
        // ç”Ÿæˆæ¸¬è©¦è³‡æ–™
        function generateTestData() {
            if (tasks.length > 0 && !confirm('å·²æœ‰å·¥åºè³‡æ–™ï¼Œç¢ºå®šè¦æ¸…ç©ºä¸¦ç”Ÿæˆæ¸¬è©¦è³‡æ–™å—ï¼Ÿ')) {
                return;
            }
            
            tasks = [];
            taskIdCounter = 1;
            
            const testTasks = [
                { category: 'water-electric', name: 'é…é›»ç®±å®‰è£', duration: 2, cost: 15000, price: 22000, status: 'completed' },
                { category: 'water-electric', name: 'é›»è·¯é…ç·š', duration: 3, cost: 25000, price: 35000, status: 'completed' },
                { category: 'water-electric', name: 'çµ¦æ°´ç®¡è·¯é…ç½®', duration: 2, cost: 18000, price: 28000, status: 'in-progress' },
                { category: 'masonry', name: 'ç‰†é¢æ‰“æ¯›è™•ç†', duration: 1, cost: 12000, price: 18000, status: 'planned' },
                { category: 'masonry', name: 'æ°´æ³¥ç²‰åˆ·', duration: 4, cost: 32000, price: 48000, status: 'planned' },
                { category: 'carpentry', name: 'å¤©èŠ±æ¿éª¨æ¶', duration: 3, cost: 22000, price: 35000, status: 'planned' },
                { category: 'carpentry', name: 'æ«¥æ«ƒè£½ä½œå®‰è£', duration: 6, cost: 85000, price: 125000, status: 'planned' },
                { category: 'painting', name: 'ç‰†é¢æ‰¹åœŸ', duration: 2, cost: 16000, price: 24000, status: 'planned' },
                { category: 'painting', name: 'é¢æ¼†å¡—åˆ·', duration: 3, cost: 22000, price: 32000, status: 'planned' },
                { category: 'flooring', name: 'åœ°é¢æ•´å¹³', duration: 2, cost: 20000, price: 30000, status: 'planned' },
                { category: 'flooring', name: 'è¶…è€ç£¨åœ°æ¿', duration: 4, cost: 65000, price: 95000, status: 'planned' }
            ];
            
            testTasks.forEach((taskData, index) => {
                const task = {
                    id: taskIdCounter++,
                    category: taskData.category,
                    name: taskData.name,
                    duration: taskData.duration,
                    cost: taskData.cost,
                    price: taskData.price,
                    profit: taskData.price - taskData.cost,
                    order: index,
                    startDate: null,
                    endDate: null,
                    status: taskData.status,
                    manuallyAdjusted: false
                };
                tasks.push(task);
            });
            
            document.getElementById('startDate').value = new Date().toISOString().split('T')[0];
            renderTaskList();
            updateSchedule();
            
            alert(`ğŸ‰ æˆåŠŸç”Ÿæˆ ${tasks.length} ç­†æ¸¬è©¦è³‡æ–™ï¼\n\næ¸¬è©¦ç”˜ç‰¹åœ–æ‹–æ‹‰åŠŸèƒ½ï¼š\nâ€¢ æ‹–å‹•å·¥åºæ¢æ”¹è®Šé–‹å§‹æ™‚é–“\nâ€¢ æ‹‰å‹•é‚Šç·£èª¿æ•´å·¥æœŸ\nâ€¢ ç³»çµ±æœƒè©¢å•æ˜¯å¦é€£å‹•èª¿æ•´å¾ŒçºŒå·¥åº`);
        }
        
        // æ¸…ç©ºè¼¸å…¥æ¬„ä½
        function clearInputs() {
            document.getElementById('taskName').value = '';
            document.getElementById('duration').value = '1';
            document.getElementById('cost').value = '';
            document.getElementById('price').value = '';
        }
        
        // æ¸…ç©ºæ‰€æœ‰
        function clearAll() {
            if (!confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å·¥åºå—ï¼Ÿ')) return;
            
            tasks = [];
            taskIdCounter = 1;
            renderTaskList();
            updateSchedule();
        }
        
        // æ¸²æŸ“å·¥åºåˆ—è¡¨
        function renderTaskList() {
            const container = document.getElementById('taskList');
            
            if (tasks.length === 0) {
                container.innerHTML = `
                    <p style="text-align: center; color: #7f8c8d; padding: 20px;">
                        å°šæœªæ–°å¢å·¥åº<br>è«‹å…ˆæ–°å¢å·¥åºé …ç›®
                    </p>
                `;
                return;
            }
            
            const sortedTasks = [...tasks].sort((a, b) => a.order - b.order);
            
            container.innerHTML = sortedTasks.map(task => `
                <div class="task-item ${task.category}" draggable="true" data-task-id="${task.id}">
                    <div class="task-info">
                        <div class="task-name">${task.name}</div>
                        <div class="task-details">
                            ${categoryNames[task.category]} | ${task.duration}å¤© | 
                            æˆæœ¬: NT$ ${task.cost.toLocaleString()} | 
                            å”®åƒ¹: NT$ ${task.price.toLocaleString()} | 
                            åˆ©æ½¤: NT$ ${task.profit.toLocaleString()}
                            ${task.startDate ? `<br>${formatDate(task.startDate)} ~ ${formatDate(task.endDate)}` : ''}
                        </div>
                    </div>
                    <div class="task-actions">
                        <button class="btn-small" onclick="deleteTask(${task.id})">åˆªé™¤</button>
                    </div>
                </div>
            `).join('');
            
            addDragEvents();
        }
        
        // æ·»åŠ æ‹–æ‹‰äº‹ä»¶
        function addDragEvents() {
            const taskItems = document.querySelectorAll('.task-item');
            
            taskItems.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', e.target.dataset.taskId);
                    e.target.classList.add('dragging');
                });
                
                item.addEventListener('dragend', (e) => {
                    e.target.classList.remove('dragging');
                });
                
                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                });
                
                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const draggedId = parseInt(e.dataTransfer.getData('text/plain'));
                    const targetId = parseInt(e.target.closest('.task-item').dataset.taskId);
                    
                    if (draggedId !== targetId) {
                        reorderTasks(draggedId, targetId);
                    }
                });
            });
        }
        
        // é‡æ–°æ’åºå·¥åº
        function reorderTasks(draggedId, targetId) {
            const draggedTask = tasks.find(t => t.id === draggedId);
            const targetTask = tasks.find(t => t.id === targetId);
            
            if (!draggedTask || !targetTask) return;
            
            const draggedOrder = draggedTask.order;
            const targetOrder = targetTask.order;
            
            if (draggedOrder < targetOrder) {
                tasks.forEach(task => {
                    if (task.order > draggedOrder && task.order <= targetOrder) {
                        task.order--;
                    }
                });
                draggedTask.order = targetOrder;
            } else {
                tasks.forEach(task => {
                    if (task.order >= targetOrder && task.order < draggedOrder) {
                        task.order++;
                    }
                });
                draggedTask.order = targetOrder;
            }
            
            renderTaskList();
            updateSchedule();
        }
        
        // åˆªé™¤å·¥åº
        function deleteTask(taskId) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å·¥åºå—ï¼Ÿ')) return;
            
            const taskIndex = tasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;
            
            const deletedOrder = tasks[taskIndex].order;
            tasks.splice(taskIndex, 1);
            
            tasks.forEach(task => {
                if (task.order > deletedOrder) {
                    task.order--;
                }
            });
            
            renderTaskList();
            updateSchedule();
        }
        
        // æ›´æ–°æ’ç¨‹
        function updateSchedule() {
            const startDateStr = document.getElementById('startDate').value;
            skipSaturday = document.getElementById('skipSaturday').checked;
            skipSunday = document.getElementById('skipSunday').checked;
            
            if (!startDateStr || tasks.length === 0) {
                updateStats();
                return;
            }
            
            projectStartDate = new Date(startDateStr);
            
            // ä½¿ç”¨æ–°çš„é‡æ–°è¨ˆç®—å‡½æ•¸
            recalculateTaskSchedule();
            
            renderCurrentView();
            renderTaskList();
            updateStats();
        }
        
        // æª¢æŸ¥æ˜¯å¦ç‚ºå·¥ä½œæ—¥
        function isWorkingDay(date) {
            const dayOfWeek = date.getDay();
            const dateStr = date.toISOString().split('T')[0];
            
            // æª¢æŸ¥è‡ªè¨‚å‡æ—¥
            if (customHolidays.has(dateStr)) return false;
            
            // æª¢æŸ¥é€±æœ«
            if (skipSunday && dayOfWeek === 0) return false;
            if (skipSaturday && dayOfWeek === 6) return false;
            return true;
        }
        
        // åˆ‡æ›æ—¥æœŸçš„ä¼‘æ¯æ—¥ç‹€æ…‹
        function toggleHoliday(dateStr) {
            if (customHolidays.has(dateStr)) {
                customHolidays.delete(dateStr);
            } else {
                customHolidays.add(dateStr);
            }
            
            // é‡æ–°è¨ˆç®—æ‰€æœ‰æœªæ‰‹å‹•èª¿æ•´çš„å·¥åº
            recalculateTaskSchedule();
            
            // é‡æ–°æ¸²æŸ“
            renderGanttChart();
            renderTaskList();
            updateStats();
        }
        
        // é‡æ–°è¨ˆç®—å·¥åºæ’ç¨‹ï¼ˆè€ƒæ…®æ–°çš„ä¼‘æ¯æ—¥ï¼‰
        function recalculateTaskSchedule() {
            if (!projectStartDate || tasks.length === 0) return;
            
            const sortedTasks = [...tasks].sort((a, b) => a.order - b.order);
            let currentDate = new Date(projectStartDate);
            
            // ç¢ºä¿å¾å·¥ä½œæ—¥é–‹å§‹
            while (!isWorkingDay(currentDate)) {
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            sortedTasks.forEach(task => {
                // åªé‡æ–°è¨ˆç®—æœªæ‰‹å‹•èª¿æ•´çš„å·¥åº
                if (!task.manuallyAdjusted) {
                    task.startDate = new Date(currentDate);
                    
                    let workDaysAdded = 0;
                    let endDate = new Date(currentDate);
                    
                    // è¨ˆç®—çµæŸæ—¥æœŸï¼Œè·³éæ‰€æœ‰ä¼‘æ¯æ—¥
                    while (workDaysAdded < task.duration) {
                        if (isWorkingDay(endDate)) {
                            workDaysAdded++;
                            if (workDaysAdded === task.duration) {
                                break;
                            }
                        }
                        endDate.setDate(endDate.getDate() + 1);
                    }
                    
                    task.endDate = endDate;
                    
                    // ä¸‹ä¸€å€‹å·¥åºå¾é€™å€‹å·¥åºçµæŸçš„éš”å¤©é–‹å§‹
                    currentDate = new Date(endDate);
                    currentDate.setDate(currentDate.getDate() + 1);
                    
                    // ç¢ºä¿ä¸‹ä¸€å€‹å·¥åºå¾å·¥ä½œæ—¥é–‹å§‹
                    while (!isWorkingDay(currentDate)) {
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                } else {
                    // å°æ–¼æ‰‹å‹•èª¿æ•´éçš„å·¥åºï¼Œä¹Ÿè¦é‡æ–°è¨ˆç®—çµæŸæ—¥æœŸï¼ˆå› ç‚ºå¯èƒ½æœ‰æ–°çš„ä¼‘æ¯æ—¥ï¼‰
                    let workDaysAdded = 0;
                    let endDate = new Date(task.startDate);
                    
                    while (workDaysAdded < task.duration) {
                        if (isWorkingDay(endDate)) {
                            workDaysAdded++;
                            if (workDaysAdded === task.duration) {
                                break;
                            }
                        }
                        endDate.setDate(endDate.getDate() + 1);
                    }
                    
                    task.endDate = endDate;
                    
                    // æ›´æ–°ä¸‹ä¸€å€‹å·¥åºçš„èµ·å§‹æ—¥æœŸåƒè€ƒé»
                    currentDate = new Date(endDate);
                    currentDate.setDate(currentDate.getDate() + 1);
                    while (!isWorkingDay(currentDate)) {
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                }
            });
        }
        
        // åˆ‡æ›è¦–åœ–
        function switchView(view, event) {
            currentView = view;
            
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            document.querySelectorAll('.view').forEach(viewElement => {
                viewElement.classList.remove('active');
            });
            
            const targetView = document.getElementById(view + 'View');
            if (targetView) {
                targetView.classList.add('active');
            }
            
            renderCurrentView();
        }
        
        // æ¸²æŸ“ç•¶å‰è¦–åœ–
        function renderCurrentView() {
            switch(currentView) {
                case 'gantt':
                    renderGanttChart();
                    break;
                case 'calendar':
                    renderCalendar();
                    break;
                case 'kanban-category':
                    renderCategoryKanban();
                    break;
                case 'kanban-status':
                    renderStatusKanban();
                    break;
                case 'list':
                    renderList();
                    break;
            }
        }
        
        // æ¸²æŸ“ç”˜ç‰¹åœ–
        function renderGanttChart() {
            const container = document.getElementById('ganttChart');
            
            if (!projectStartDate || tasks.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #7f8c8d; padding: 50px;">
                        <h3>è«‹è¨­å®šå°ˆæ¡ˆé–‹å§‹æ—¥æœŸä¸¦æ–°å¢å·¥åº</h3>
                        <p>ç³»çµ±å°‡è‡ªå‹•ç”¢ç”Ÿæ³³é“ç”˜ç‰¹åœ–</p>
                        <p style="margin-top: 10px; font-size: 14px;">
                            æç¤ºï¼šç”˜ç‰¹åœ–ä¸­çš„å·¥åºæ¢å¯ä»¥ï¼š<br>
                            â€¢ æ‹–æ‹½ç§»å‹•èª¿æ•´é–‹å§‹æ™‚é–“<br>
                            â€¢ æ‹‰å‹•å·¦å³é‚Šç·£èª¿æ•´å·¥æœŸé•·åº¦<br>
                            â€¢ é»æ“Šæ—¥æœŸå¯è¨­å®šç‚ºä¼‘æ¯æ—¥ï¼ˆç´«è‰²ï¼‰
                        </p>
                    </div>
                `;
                return;
            }
            
            const sortedTasks = [...tasks].filter(t => t.startDate && t.endDate).sort((a, b) => a.order - b.order);
            
            if (sortedTasks.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #e74c3c; padding: 50px;">
                        <h3>æ’ç¨‹è¨ˆç®—ä¸­...</h3>
                        <p>è«‹ç¨å€™ï¼Œæ­£åœ¨è¨ˆç®—å·¥åºæ’ç¨‹</p>
                    </div>
                `;
                return;
            }
            
            const lastTask = sortedTasks[sortedTasks.length - 1];
            const projectEndDate = lastTask.endDate;
            
            const totalDays = Math.ceil((projectEndDate - projectStartDate) / (1000 * 60 * 60 * 24)) + 1;
            
            const dates = [];
            for (let i = 0; i < Math.min(totalDays + 10, 90); i++) {
                const date = new Date(projectStartDate);
                date.setDate(date.getDate() + i);
                dates.push(date);
            }
            
            const categories = [...new Set(sortedTasks.map(t => t.category))];
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let html = '<div class="gantt-chart">';
            
            // è¡¨é ­
            html += '<div class="gantt-header">';
            html += '<div class="gantt-lane-header">å·¥ç¨‹é¡åˆ¥</div>';
            html += '<div class="gantt-timeline-header">';
            html += '<div class="gantt-days-container">';
            
            dates.forEach(date => {
                const dayOfWeek = date.getDay();
                const dateStr = date.toISOString().split('T')[0];
                const isWeekend = (skipSunday && dayOfWeek === 0) || (skipSaturday && dayOfWeek === 6);
                const isHoliday = customHolidays.has(dateStr);
                const isToday = date.getTime() === today.getTime();
                
                let cssClass = '';
                if (isToday) cssClass = 'today';
                else if (isHoliday) cssClass = 'holiday';
                else if (isWeekend) cssClass = 'weekend';
                
                html += `<div class="gantt-day ${cssClass}" onclick="toggleHoliday('${dateStr}')" title="é»æ“Šè¨­å®š/å–æ¶ˆä¼‘æ¯æ—¥">
                    ${date.getDate()}<br>
                    ${getWeekdayName(dayOfWeek)}
                </div>`;
            });
            
            html += '</div></div></div>';
            
            // å„å·¥ç¨‹é¡åˆ¥æ³³é“
            categories.forEach(category => {
                const categoryTasks = sortedTasks.filter(t => t.category === category);
                
                html += '<div class="gantt-lane">';
                html += `<div class="gantt-lane-label">${categoryNames[category]}</div>`;
                html += '<div class="gantt-lane-content">';
                
                // èƒŒæ™¯ç¶²æ ¼
                html += '<div class="gantt-grid">';
                dates.forEach(date => {
                    const dayOfWeek = date.getDay();
                    const dateStr = date.toISOString().split('T')[0];
                    const isWeekend = (skipSunday && dayOfWeek === 0) || (skipSaturday && dayOfWeek === 6);
                    const isHoliday = customHolidays.has(dateStr);
                    const isToday = date.getTime() === today.getTime();
                    
                    let cssClass = '';
                    if (isToday) cssClass = 'today';
                    else if (isHoliday) cssClass = 'holiday';
                    else if (isWeekend) cssClass = 'weekend';
                    
                    html += `<div class="gantt-day-column ${cssClass}"></div>`;
                });
                html += '</div>';
                
                // å·¥åºæ¢ - ç°¡åŒ–ç‰ˆæœ¬ï¼Œä¸ä½¿ç”¨åˆ†æ®µ
                categoryTasks.forEach(task => {
                    const startDay = Math.floor((task.startDate - projectStartDate) / (1000 * 60 * 60 * 24));
                    const endDay = Math.floor((task.endDate - projectStartDate) / (1000 * 60 * 60 * 24));
                    const duration = endDay - startDay + 1;
                    
                    if (startDay >= 0 && startDay < dates.length) {
                        const width = Math.min(duration * 40, (dates.length - startDay) * 40);
                        
                        html += `<div class="gantt-task ${task.category}" 
                            data-task-id="${task.id}"
                            style="left: ${startDay * 40}px; width: ${width}px;" 
                            title="${task.name}&#10;${formatDate(task.startDate)} ~ ${formatDate(task.endDate)}&#10;${task.duration}å¤© | æˆæœ¬: NT$ ${task.cost.toLocaleString()} | å”®åƒ¹: NT$ ${task.price.toLocaleString()}">
                            <div class="resize-handle resize-handle-left"></div>
                            <span>${task.name}</span>
                            <div class="resize-handle resize-handle-right"></div>
                        </div>`;
                    }
                });
                
                html += '</div></div>';
            });
            
            html += '</div>';
            container.innerHTML = html;
            
            // ç¶å®šç”˜ç‰¹åœ–æ‹–æ‹½äº‹ä»¶
            setTimeout(() => bindGanttDragEvents(), 100);
        }
        
        // ç¶å®šç”˜ç‰¹åœ–æ‹–æ‹½å’Œèª¿æ•´å¤§å°äº‹ä»¶
        function bindGanttDragEvents() {
            const ganttTasks = document.querySelectorAll('.gantt-task');
            
            ganttTasks.forEach(taskElement => {
                const taskId = parseInt(taskElement.dataset.taskId);
                const task = tasks.find(t => t.id === taskId);
                if (!task) return;
                
                // æ‹–æ‹½ç§»å‹•
                taskElement.addEventListener('mousedown', (e) => {
                    // æª¢æŸ¥æ˜¯å¦é»æ“Šèª¿æ•´æ‰‹æŸ„
                    if (e.target.classList.contains('resize-handle')) {
                        handleResize(e, taskElement, task);
                    } else {
                        handleDrag(e, taskElement, task);
                    }
                });
            });
        }
        
        // è™•ç†æ‹–æ‹½
        function handleDrag(e, taskElement, task) {
            e.preventDefault();
            
            const startX = e.clientX;
            const startLeft = parseInt(taskElement.style.left);
            const originalStartDate = new Date(task.startDate);
            const lane = taskElement.parentElement;
            
            taskElement.classList.add('dragging');
            
            const handleMouseMove = (e) => {
                const deltaX = e.clientX - startX;
                const newLeft = startLeft + deltaX;
                
                // é™åˆ¶åœ¨æ³³é“å…§
                const maxLeft = lane.offsetWidth - taskElement.offsetWidth;
                const constrainedLeft = Math.max(0, Math.min(newLeft, maxLeft));
                
                // å°é½Šåˆ°ç¶²æ ¼ï¼ˆ40pxï¼‰
                const gridLeft = Math.round(constrainedLeft / 40) * 40;
                
                taskElement.style.left = gridLeft + 'px';
            };
            
            const handleMouseUp = () => {
                taskElement.classList.remove('dragging');
                
                // è¨ˆç®—æ–°çš„é–‹å§‹æ—¥æœŸ
                const newStartDay = Math.round(parseInt(taskElement.style.left) / 40);
                const newStartDate = new Date(projectStartDate);
                newStartDate.setDate(newStartDate.getDate() + newStartDay);
                
                // æª¢æŸ¥æ˜¯å¦æœ‰å¯¦éš›ç§»å‹•
                const daysDiff = Math.floor((newStartDate - originalStartDate) / (1000 * 60 * 60 * 24));
                
                if (daysDiff === 0) {
                    // æ²’æœ‰ç§»å‹•ï¼Œä¸éœ€è¦æ›´æ–°
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                    return;
                }
                
                // è¨ˆç®—æ–°çš„çµæŸæ—¥æœŸï¼ˆä¿æŒåŸæœ‰å·¥æœŸï¼‰
                let workDaysAdded = 0;
                let newEndDate = new Date(newStartDate);
                
                while (workDaysAdded < task.duration) {
                    if (isWorkingDay(newEndDate)) {
                        workDaysAdded++;
                        if (workDaysAdded === task.duration) {
                            break;
                        }
                    }
                    newEndDate.setDate(newEndDate.getDate() + 1);
                }
                
                // æ‰¾å‡ºå¾ŒçºŒå·¥åº
                const laterTasks = tasks.filter(t => 
                    t.order > task.order && 
                    t.startDate && 
                    t.startDate >= originalStartDate
                );
                
                // è©¢å•æ˜¯å¦è¦èª¿æ•´å¾ŒçºŒå·¥åº
                let adjustLaterTasks = false;
                if (laterTasks.length > 0) {
                    const message = daysDiff > 0 
                        ? `æ­¤å·¥åºå»¶å¾Œäº† ${Math.abs(daysDiff)} å¤©ï¼Œæ˜¯å¦è¦é€£å‹•èª¿æ•´å¾ŒçºŒ ${laterTasks.length} å€‹å·¥åºï¼Ÿ\n\n` +
                          `é¸æ“‡ã€Œç¢ºå®šã€ï¼šå¾ŒçºŒå·¥åºå°‡é †å»¶ ${Math.abs(daysDiff)} å¤©\n` +
                          `é¸æ“‡ã€Œå–æ¶ˆã€ï¼šåªèª¿æ•´æ­¤å·¥åºï¼Œå¾ŒçºŒå·¥åºä¿æŒä¸è®Š`
                        : `æ­¤å·¥åºæå‰äº† ${Math.abs(daysDiff)} å¤©ï¼Œæ˜¯å¦è¦é€£å‹•èª¿æ•´å¾ŒçºŒ ${laterTasks.length} å€‹å·¥åºï¼Ÿ\n\n` +
                          `é¸æ“‡ã€Œç¢ºå®šã€ï¼šå¾ŒçºŒå·¥åºå°‡æå‰ ${Math.abs(daysDiff)} å¤©\n` +
                          `é¸æ“‡ã€Œå–æ¶ˆã€ï¼šåªèª¿æ•´æ­¤å·¥åºï¼Œå¾ŒçºŒå·¥åºä¿æŒä¸è®Š`;
                    
                    adjustLaterTasks = confirm(message);
                }
                
                // æ›´æ–°ä»»å‹™æ—¥æœŸ
                task.startDate = newStartDate;
                task.endDate = newEndDate;
                task.manuallyAdjusted = true;
                
                // å¦‚æœéœ€è¦èª¿æ•´å¾ŒçºŒå·¥åº
                if (adjustLaterTasks) {
                    laterTasks.forEach(laterTask => {
                        const newLaterStart = new Date(laterTask.startDate);
                        newLaterStart.setDate(newLaterStart.getDate() + daysDiff);
                        
                        const newLaterEnd = new Date(laterTask.endDate);
                        newLaterEnd.setDate(newLaterEnd.getDate() + daysDiff);
                        
                        laterTask.startDate = newLaterStart;
                        laterTask.endDate = newLaterEnd;
                        laterTask.manuallyAdjusted = true;
                    });
                }
                
                // é‡æ–°æ¸²æŸ“
                renderGanttChart();
                renderTaskList();
                updateStats();
                
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
            };
            
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
        }
        
        // è™•ç†èª¿æ•´å¤§å°
        function handleResize(e, taskElement, task) {
            e.preventDefault();
            e.stopPropagation();
            
            const isLeftHandle = e.target.classList.contains('resize-handle-left');
            const startX = e.clientX;
            const startWidth = parseInt(taskElement.style.width);
            const startLeft = parseInt(taskElement.style.left);
            const originalDuration = task.duration;
            const originalStartDate = new Date(task.startDate);
            const originalEndDate = new Date(task.endDate);
            
            taskElement.classList.add('resizing');
            
            const handleMouseMove = (e) => {
                const deltaX = e.clientX - startX;
                
                if (isLeftHandle) {
                    // èª¿æ•´å·¦é‚Šï¼ˆé–‹å§‹æ—¥æœŸï¼‰
                    const newLeft = startLeft + deltaX;
                    const newWidth = startWidth - deltaX;
                    
                    if (newWidth >= 40 && newLeft >= 0) {
                        // å°é½Šåˆ°ç¶²æ ¼
                        const gridLeft = Math.round(newLeft / 40) * 40;
                        const gridWidth = Math.round(newWidth / 40) * 40;
                        
                        taskElement.style.left = gridLeft + 'px';
                        taskElement.style.width = Math.max(40, gridWidth) + 'px';
                    }
                } else {
                    // èª¿æ•´å³é‚Šï¼ˆçµæŸæ—¥æœŸï¼‰
                    const newWidth = startWidth + deltaX;
                    
                    if (newWidth >= 40) {
                        // å°é½Šåˆ°ç¶²æ ¼
                        const gridWidth = Math.round(newWidth / 40) * 40;
                        taskElement.style.width = Math.max(40, gridWidth) + 'px';
                    }
                }
            };
            
            const handleMouseUp = () => {
                taskElement.classList.remove('resizing');
                
                // è¨ˆç®—æ–°çš„æ—¥æœŸ
                const newStartDay = Math.round(parseInt(taskElement.style.left) / 40);
                const newDuration = Math.round(parseInt(taskElement.style.width) / 40);
                
                // æª¢æŸ¥æ˜¯å¦æœ‰å¯¦éš›è®ŠåŒ–
                if (newDuration === originalDuration && newStartDay === Math.floor((originalStartDate - projectStartDate) / (1000 * 60 * 60 * 24))) {
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                    return;
                }
                
                const newStartDate = new Date(projectStartDate);
                newStartDate.setDate(newStartDate.getDate() + newStartDay);
                
                // è¨ˆç®—æ–°çš„çµæŸæ—¥æœŸ
                let workDaysAdded = 0;
                let newEndDate = new Date(newStartDate);
                
                while (workDaysAdded < newDuration) {
                    if (isWorkingDay(newEndDate)) {
                        workDaysAdded++;
                        if (workDaysAdded === newDuration) {
                            break;
                        }
                    }
                    newEndDate.setDate(newEndDate.getDate() + 1);
                }
                
                // è¨ˆç®—è®ŠåŒ–é‡
                const startDateDiff = Math.floor((newStartDate - originalStartDate) / (1000 * 60 * 60 * 24));
                const endDateDiff = Math.floor((newEndDate - originalEndDate) / (1000 * 60 * 60 * 24));
                const durationDiff = newDuration - originalDuration;
                
                // æ‰¾å‡ºå¾ŒçºŒå·¥åº
                const laterTasks = tasks.filter(t => 
                    t.order > task.order && 
                    t.startDate && 
                    t.startDate >= originalEndDate
                );
                
                // è©¢å•æ˜¯å¦è¦èª¿æ•´å¾ŒçºŒå·¥åº
                let adjustLaterTasks = false;
                if (laterTasks.length > 0 && endDateDiff !== 0) {
                    let message = '';
                    
                    if (durationDiff !== 0) {
                        message = durationDiff > 0 
                            ? `æ­¤å·¥åºå·¥æœŸå¢åŠ äº† ${Math.abs(durationDiff)} å¤©ï¼ˆ${originalDuration}å¤© â†’ ${newDuration}å¤©ï¼‰ã€‚\n\næ˜¯å¦è¦å°‡å¾ŒçºŒ ${laterTasks.length} å€‹å·¥åºé †å»¶ ${Math.abs(endDateDiff)} å¤©ï¼Ÿ`
                            : `æ­¤å·¥åºå·¥æœŸæ¸›å°‘äº† ${Math.abs(durationDiff)} å¤©ï¼ˆ${originalDuration}å¤© â†’ ${newDuration}å¤©ï¼‰ã€‚\n\næ˜¯å¦è¦å°‡å¾ŒçºŒ ${laterTasks.length} å€‹å·¥åºæå‰ ${Math.abs(endDateDiff)} å¤©ï¼Ÿ`;
                    }
                    
                    if (message) {
                        message += '\n\né¸æ“‡ã€Œç¢ºå®šã€ï¼šå¾ŒçºŒå·¥åºå°‡é€£å‹•èª¿æ•´\né¸æ“‡ã€Œå–æ¶ˆã€ï¼šåªèª¿æ•´æ­¤å·¥åº';
                        adjustLaterTasks = confirm(message);
                    }
                }
                
                // æ›´æ–°ä»»å‹™
                task.startDate = newStartDate;
                task.endDate = newEndDate;
                task.duration = newDuration;
                task.manuallyAdjusted = true;
                
                // å¦‚æœéœ€è¦èª¿æ•´å¾ŒçºŒå·¥åº
                if (adjustLaterTasks && endDateDiff !== 0) {
                    laterTasks.forEach(laterTask => {
                        const newLaterStart = new Date(laterTask.startDate);
                        newLaterStart.setDate(newLaterStart.getDate() + endDateDiff);
                        
                        const newLaterEnd = new Date(laterTask.endDate);
                        newLaterEnd.setDate(newLaterEnd.getDate() + endDateDiff);
                        
                        laterTask.startDate = newLaterStart;
                        laterTask.endDate = newLaterEnd;
                        laterTask.manuallyAdjusted = true;
                    });
                }
                
                // é‡æ–°æ¸²æŸ“
                renderGanttChart();
                renderTaskList();
                updateStats();
                
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
            };
            
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
        }
        
        // æ¸²æŸ“æ—¥æ›†
        function renderCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            document.getElementById('calendarTitle').textContent = `${year}å¹´${month + 1}æœˆ`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const firstDayWeekday = firstDay.getDay();
            
            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';
            
            const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            weekdays.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day';
                dayHeader.style.background = '#2c3e50';
                dayHeader.style.color = 'white';
                dayHeader.style.fontWeight = 'bold';
                dayHeader.style.textAlign = 'center';
                dayHeader.style.padding = '10px';
                dayHeader.style.minHeight = 'auto';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });
            
            for (let i = firstDayWeekday - 1; i >= 0; i--) {
                const date = new Date(firstDay);
                date.setDate(date.getDate() - i - 1);
                const dayElement = createCalendarDay(date, true);
                calendarGrid.appendChild(dayElement);
            }
            
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(year, month, day);
                const dayElement = createCalendarDay(date, false);
                calendarGrid.appendChild(dayElement);
            }
            
            const totalCells = calendarGrid.children.length;
            const remainingCells = 42 - totalCells;
            for (let day = 1; day <= remainingCells; day++) {
                const date = new Date(year, month + 1, day);
                const dayElement = createCalendarDay(date, true);
                calendarGrid.appendChild(dayElement);
            }
        }
        
        // å‰µå»ºæ—¥æ›†æ—¥æœŸå…ƒç´ 
        function createCalendarDay(date, isOtherMonth) {
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';
            
            if (isOtherMonth) {
                dayElement.classList.add('other-month');
            }
            
            if (date.getDay() === 0 || date.getDay() === 6) {
                dayElement.classList.add('weekend');
            }
            
            const dayNumber = document.createElement('div');
            dayNumber.className = 'calendar-day-number';
            dayNumber.textContent = date.getDate();
            dayElement.appendChild(dayNumber);
            
            if (!isOtherMonth) {
                const dayTasks = tasks.filter(task => {
                    if (!task.startDate || !task.endDate) return false;
                    const taskStart = new Date(task.startDate.getFullYear(), task.startDate.getMonth(), task.startDate.getDate());
                    const taskEnd = new Date(task.endDate.getFullYear(), task.endDate.getMonth(), task.endDate.getDate());
                    const currentDay = new Date(date.getFullYear(), date.getMonth(), date.getDate());
                    return currentDay >= taskStart && currentDay <= taskEnd;
                });
                
                dayTasks.forEach(task => {
                    const taskElement = document.createElement('div');
                    taskElement.className = `calendar-task ${task.category}`;
                    taskElement.textContent = task.name;
                    taskElement.title = `${task.name} - ${categoryNames[task.category]}`;
                    dayElement.appendChild(taskElement);
                });
            }
            
            return dayElement;
        }
        
        // æ—¥æ›†å°èˆª
        function navigateCalendar(direction) {
            if (direction === 0) {
                currentCalendarDate = new Date();
            } else {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
            }
            renderCalendar();
        }
        
        // æ¸²æŸ“å·¥ç¨‹åˆ†é¡çœ‹æ¿
        function renderCategoryKanban() {
            const board = document.getElementById('categoryKanbanBoard');
            board.innerHTML = '';
            
            const categories = Object.keys(categoryNames);
            
            categories.forEach(category => {
                const column = document.createElement('div');
                column.className = 'kanban-column';
                
                const header = document.createElement('div');
                header.className = `kanban-header ${category}`;
                header.textContent = categoryNames[category];
                column.appendChild(header);
                
                const content = document.createElement('div');
                
                const categoryTasks = tasks.filter(t => t.category === category).sort((a, b) => a.order - b.order);
                
                categoryTasks.forEach(task => {
                    const card = createKanbanCard(task, false);
                    content.appendChild(card);
                });
                
                column.appendChild(content);
                board.appendChild(column);
            });
        }
        
        // æ¸²æŸ“é€²åº¦ç‹€æ…‹çœ‹æ¿
        function renderStatusKanban() {
            const columns = {
                'planned': document.getElementById('kanbanPlanned'),
                'in-progress': document.getElementById('kanbanInProgress'),
                'completed': document.getElementById('kanbanCompleted'),
                'blocked': document.getElementById('kanbanBlocked')
            };
            
            Object.values(columns).forEach(column => column.innerHTML = '');
            
            tasks.forEach(task => {
                const card = createKanbanCard(task, true);
                card.onclick = () => changeTaskStatus(task.id);
                
                if (columns[task.status]) {
                    columns[task.status].appendChild(card);
                }
            });
        }
        
        // å‰µå»ºçœ‹æ¿å¡ç‰‡
        function createKanbanCard(task, showStatusChange = false) {
            const card = document.createElement('div');
            card.className = 'kanban-card';
            
            const title = document.createElement('div');
            title.className = 'kanban-card-title';
            title.textContent = task.name;
            card.appendChild(title);
            
            const details = document.createElement('div');
            details.className = 'kanban-card-details';
            details.innerHTML = `
                ${categoryNames[task.category]} | ${task.duration}å¤©<br>
                ${task.startDate ? `${formatDate(task.startDate)} ~ ${formatDate(task.endDate)}` : 'å°šæœªæ’ç¨‹'}
            `;
            card.appendChild(details);
            
            const financial = document.createElement('div');
            financial.className = 'kanban-card-financial';
            financial.innerHTML = `
                æˆæœ¬: NT$ ${task.cost.toLocaleString()}<br>
                å”®åƒ¹: NT$ ${task.price.toLocaleString()}<br>
                <strong>åˆ©æ½¤: NT$ ${task.profit.toLocaleString()}</strong>
            `;
            card.appendChild(financial);
            
            const statusDiv = document.createElement('div');
            statusDiv.className = 'kanban-card-status';
            const statusSpan = document.createElement('span');
            statusSpan.className = `status-indicator ${task.status.replace('-', '')}`;
            statusSpan.textContent = getStatusText(task.status);
            statusDiv.appendChild(statusSpan);
            card.appendChild(statusDiv);
            
            if (showStatusChange) {
                card.style.cursor = 'pointer';
                card.title = 'é»æ“Šåˆ‡æ›ç‹€æ…‹';
            }
            
            return card;
        }
        
        // æ”¹è®Šå·¥åºç‹€æ…‹
        function changeTaskStatus(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            const statuses = ['planned', 'in-progress', 'completed', 'blocked'];
            const currentIndex = statuses.indexOf(task.status);
            const nextIndex = (currentIndex + 1) % statuses.length;
            
            task.status = statuses[nextIndex];
            renderStatusKanban();
        }
        
        // æ¸²æŸ“åˆ—è¡¨
        function renderList() {
            const tbody = document.getElementById('listTableBody');
            tbody.innerHTML = '';
            
            const sortedTasks = [...tasks].sort((a, b) => a.order - b.order);
            
            sortedTasks.forEach(task => {
                const row = document.createElement('tr');
                row.dataset.taskId = task.id;
                
                const statusClass = `status-${task.status.replace('-', '')}`;
                
                row.innerHTML = `
                    <td>
                        <div class="editable-cell" data-field="name" data-task-id="${task.id}">${task.name}</div>
                    </td>
                    <td>
                        <div class="editable-cell" data-field="category" data-task-id="${task.id}">${categoryNames[task.category]}</div>
                    </td>
                    <td>
                        <div class="editable-cell" data-field="duration" data-task-id="${task.id}">${task.duration}å¤©</div>
                    </td>
                    <td>
                        <div class="editable-cell" data-field="cost" data-task-id="${task.id}">NT$ ${task.cost.toLocaleString()}</div>
                    </td>
                    <td>
                        <div class="editable-cell" data-field="price" data-task-id="${task.id}">NT$ ${task.price.toLocaleString()}</div>
                    </td>
                    <td style="color: ${task.profit >= 0 ? '#27ae60' : '#e74c3c'};">
                        NT$ ${task.profit.toLocaleString()}
                    </td>
                    <td>
                        <div class="editable-cell" data-field="startDate" data-task-id="${task.id}">
                            ${task.startDate ? task.startDate.toISOString().split('T')[0] : '-'}
                        </div>
                    </td>
                    <td>${task.endDate ? task.endDate.toISOString().split('T')[0] : '-'}</td>
                    <td>
                        <span class="status-badge ${statusClass}" data-field="status" data-task-id="${task.id}">
                            ${getStatusText(task.status)}
                        </span>
                    </td>
                    <td>
                        <button class="btn-small" onclick="deleteTask(${task.id})">åˆªé™¤</button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            // ç¶å®šç·¨è¼¯äº‹ä»¶
            bindEditableEvents();
        }
        
        // ç¶å®šå¯ç·¨è¼¯å–®å…ƒæ ¼çš„äº‹ä»¶
        function bindEditableEvents() {
            // ç¶å®šå¯ç·¨è¼¯å–®å…ƒæ ¼
            document.querySelectorAll('.editable-cell').forEach(cell => {
                cell.addEventListener('click', handleCellEdit);
            });
            
            // ç¶å®šç‹€æ…‹æ¨™ç±¤
            document.querySelectorAll('.status-badge').forEach(badge => {
                badge.addEventListener('click', handleStatusEdit);
            });
        }
        
        // è™•ç†å–®å…ƒæ ¼ç·¨è¼¯
        function handleCellEdit(e) {
            const cell = e.target;
            if (cell.classList.contains('editing')) return;
            
            const taskId = parseInt(cell.dataset.taskId);
            const field = cell.dataset.field;
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            cell.classList.add('editing');
            const originalValue = task[field];
            let inputElement;
            
            switch(field) {
                case 'name':
                    inputElement = document.createElement('input');
                    inputElement.type = 'text';
                    inputElement.value = originalValue;
                    inputElement.className = 'edit-input';
                    break;
                    
                case 'category':
                    inputElement = document.createElement('select');
                    inputElement.className = 'edit-select';
                    Object.keys(categoryNames).forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat;
                        option.textContent = categoryNames[cat];
                        if (cat === task.category) option.selected = true;
                        inputElement.appendChild(option);
                    });
                    break;
                    
                case 'duration':
                    inputElement = document.createElement('input');
                    inputElement.type = 'number';
                    inputElement.value = originalValue;
                    inputElement.min = '1';
                    inputElement.className = 'edit-input';
                    break;
                    
                case 'cost':
                case 'price':
                    inputElement = document.createElement('input');
                    inputElement.type = 'number';
                    inputElement.value = originalValue;
                    inputElement.min = '0';
                    inputElement.className = 'edit-input';
                    break;
                    
                case 'startDate':
                    inputElement = document.createElement('input');
                    inputElement.type = 'date';
                    inputElement.value = originalValue ? originalValue.toISOString().split('T')[0] : '';
                    inputElement.className = 'edit-input';
                    break;
                    
                default:
                    return;
            }
            
            cell.innerHTML = '';
            cell.appendChild(inputElement);
            inputElement.focus();
            inputElement.select();
            
            // å„²å­˜ç·¨è¼¯
            const saveEdit = () => {
                let newValue = inputElement.value;
                let needsScheduleUpdate = false;
                
                switch(field) {
                    case 'name':
                        if (newValue.trim()) {
                            task.name = newValue.trim();
                        }
                        break;
                        
                    case 'category':
                        task.category = newValue;
                        break;
                        
                    case 'duration':
                        const duration = parseInt(newValue);
                        if (duration > 0 && duration !== task.duration) {
                            const originalDuration = task.duration;
                            task.duration = duration;
                            task.manuallyAdjusted = true;
                            needsScheduleUpdate = true;
                            
                            // è©¢å•æ˜¯å¦èª¿æ•´å¾ŒçºŒå·¥åº
                            const laterTasks = tasks.filter(t => t.order > task.order);
                            if (laterTasks.length > 0) {
                                const durationDiff = duration - originalDuration;
                                const message = durationDiff > 0 
                                    ? `å·¥æœŸå¢åŠ äº† ${Math.abs(durationDiff)} å¤©ï¼Œæ˜¯å¦è¦å°‡å¾ŒçºŒ ${laterTasks.length} å€‹å·¥åºé †å»¶ï¼Ÿ`
                                    : `å·¥æœŸæ¸›å°‘äº† ${Math.abs(durationDiff)} å¤©ï¼Œæ˜¯å¦è¦å°‡å¾ŒçºŒ ${laterTasks.length} å€‹å·¥åºæå‰ï¼Ÿ`;
                                
                                if (confirm(message)) {
                                    // é‡æ–°è¨ˆç®—æ‰€æœ‰å·¥åº
                                    recalculateTaskSchedule();
                                } else {
                                    // åªé‡æ–°è¨ˆç®—ç•¶å‰å·¥åºçš„çµæŸæ—¥æœŸ
                                    recalculateSingleTask(task);
                                }
                            } else {
                                // æ²’æœ‰å¾ŒçºŒå·¥åºï¼Œåªé‡æ–°è¨ˆç®—ç•¶å‰å·¥åº
                                recalculateSingleTask(task);
                            }
                        }
                        break;
                        
                    case 'cost':
                    case 'price':
                        const value = parseInt(newValue) || 0;
                        task[field] = value;
                        task.profit = task.price - task.cost;
                        break;
                        
                    case 'startDate':
                        if (newValue) {
                            const newStartDate = new Date(newValue);
                            const originalStartDate = task.startDate ? new Date(task.startDate) : null;
                            
                            if (!originalStartDate || newStartDate.getTime() !== originalStartDate.getTime()) {
                                task.startDate = newStartDate;
                                task.manuallyAdjusted = true;
                                needsScheduleUpdate = true;
                                
                                // è©¢å•æ˜¯å¦èª¿æ•´å¾ŒçºŒå·¥åº
                                const laterTasks = tasks.filter(t => t.order > task.order);
                                if (laterTasks.length > 0) {
                                    if (confirm(`é–‹å§‹æ—¥æœŸå·²è®Šæ›´ï¼Œæ˜¯å¦è¦é€£å‹•èª¿æ•´å¾ŒçºŒ ${laterTasks.length} å€‹å·¥åºï¼Ÿ`)) {
                                        // é‡æ–°è¨ˆç®—æ‰€æœ‰å·¥åº
                                        recalculateTaskSchedule();
                                    } else {
                                        // åªé‡æ–°è¨ˆç®—ç•¶å‰å·¥åº
                                        recalculateSingleTask(task);
                                    }
                                } else {
                                    // æ²’æœ‰å¾ŒçºŒå·¥åºï¼Œåªé‡æ–°è¨ˆç®—ç•¶å‰å·¥åº
                                    recalculateSingleTask(task);
                                }
                            }
                        }
                        break;
                }
                
                // é‡æ–°æ¸²æŸ“æ‰€æœ‰è¦–åœ–
                renderList();
                renderTaskList();
                renderGanttChart();
                if (currentView === 'calendar') renderCalendar();
                if (currentView === 'kanban-category') renderCategoryKanban();
                if (currentView === 'kanban-status') renderStatusKanban();
                updateStats();
            };
            
            // å–æ¶ˆç·¨è¼¯
            const cancelEdit = () => {
                cell.classList.remove('editing');
                renderList();
            };
            
            // ç¶å®šäº‹ä»¶
            inputElement.addEventListener('blur', saveEdit);
            inputElement.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveEdit();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelEdit();
                }
            });
        }
        
        // é‡æ–°è¨ˆç®—å–®ä¸€å·¥åºï¼ˆè€ƒæ…®ä¼‘æ¯æ—¥ï¼‰
        function recalculateSingleTask(task) {
            if (!task.startDate) return;
            
            let workDaysAdded = 0;
            let endDate = new Date(task.startDate);
            
            // ç¢ºä¿å¾å·¥ä½œæ—¥é–‹å§‹
            if (!isWorkingDay(endDate)) {
                while (!isWorkingDay(endDate)) {
                    endDate.setDate(endDate.getDate() + 1);
                }
                task.startDate = new Date(endDate);
            }
            
            // è¨ˆç®—çµæŸæ—¥æœŸï¼Œè·³éæ‰€æœ‰ä¼‘æ¯æ—¥
            workDaysAdded = 0;
            endDate = new Date(task.startDate);
            
            while (workDaysAdded < task.duration) {
                if (isWorkingDay(endDate)) {
                    workDaysAdded++;
                    if (workDaysAdded === task.duration) {
                        break;
                    }
                }
                endDate.setDate(endDate.getDate() + 1);
            }
            
            task.endDate = endDate;
        }
        
        // è™•ç†ç‹€æ…‹ç·¨è¼¯
        function handleStatusEdit(e) {
            const badge = e.target;
            const taskId = parseInt(badge.dataset.taskId);
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            const statuses = ['planned', 'in-progress', 'completed', 'blocked'];
            const currentIndex = statuses.indexOf(task.status);
            const nextIndex = (currentIndex + 1) % statuses.length;
            
            task.status = statuses[nextIndex];
            renderList();
            renderCurrentView();
        }
        
        // ç²å–ç‹€æ…‹æ–‡å­—
        function getStatusText(status) {
            const statusMap = {
                'planned': 'è¨ˆåŠƒä¸­',
                'in-progress': 'é€²è¡Œä¸­',
                'completed': 'å·²å®Œæˆ',
                'blocked': 'é˜»å¡'
            };
            return statusMap[status] || status;
        }
        
        // ç²å–æ˜ŸæœŸåç¨±
        function getWeekdayName(dayOfWeek) {
            const names = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            return names[dayOfWeek];
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(date) {
            return `${date.getMonth() + 1}/${date.getDate()}`;
        }
        
        // æ›´æ–°çµ±è¨ˆè³‡è¨Š
        function updateStats() {
            const totalTasks = tasks.length;
            const totalCost = tasks.reduce((sum, task) => sum + task.cost, 0);
            const totalPrice = tasks.reduce((sum, task) => sum + task.price, 0);
            const totalProfit = totalPrice - totalCost;
            let totalDays = 0;
            let endDate = '-';
            
            if (tasks.length > 0 && projectStartDate) {
                const sortedTasks = [...tasks].sort((a, b) => a.order - b.order);
                const lastTask = sortedTasks[sortedTasks.length - 1];
                
                if (lastTask && lastTask.endDate) {
                    totalDays = Math.ceil((lastTask.endDate - projectStartDate) / (1000 * 60 * 60 * 24)) + 1;
                    endDate = `${lastTask.endDate.getMonth() + 1}/${lastTask.endDate.getDate()}`;
                }
            }
            
            document.getElementById('totalTasks').textContent = totalTasks;
            document.getElementById('totalCost').textContent = 'NT$ ' + totalCost.toLocaleString();
            document.getElementById('totalPrice').textContent = 'NT$ ' + totalPrice.toLocaleString();
            document.getElementById('totalProfit').textContent = 'NT$ ' + totalProfit.toLocaleString();
            document.getElementById('totalDays').textContent = totalDays;
            document.getElementById('projectEndDate').textContent = endDate;
        }
        
        // äº‹ä»¶ç›£è½
        document.getElementById('startDate').addEventListener('change', updateSchedule);
        document.getElementById('skipSaturday').addEventListener('change', updateSchedule);
        document.getElementById('skipSunday').addEventListener('change', updateSchedule);
        
        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>